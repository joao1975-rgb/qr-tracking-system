<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de C√≥digos QR</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .generator-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f8fafc;
            min-height: 100vh;
        }
        
        .campaigns-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
        
        .campaign-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
        }
        
        .qr-container {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: #f8fafc;
            border-radius: 10px;
        }
        
        .qr-code {
            max-width: 200px;
            max-height: 200px;
            margin: 0 auto;
        }
        
        .campaign-info {
            margin-bottom: 20px;
        }
        
        .campaign-url {
            background: #e0e7ff;
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.85em;
            word-break: break-all;
            color: #4f46e5;
            margin: 10px 0;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 0.9em;
            min-width: auto;
        }
        
        @media (max-width: 768px) {
            .campaigns-grid {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="generator-container">
        <!-- Header -->
        <div class="header">
            <h1>üì± Generador de C√≥digos QR</h1>
            <p class="subtitle">C√≥digos QR para campa√±as de tracking configuradas</p>
        </div>

        <!-- Informaci√≥n general -->
        <div style="background: white; border-radius: 15px; padding: 30px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);">
            <h2 style="color: #374151; margin-bottom: 20px;">‚ÑπÔ∏è Instrucciones</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <div>
                    <h4 style="color: #4f46e5;">1. Generar QR</h4>
                    <p style="color: #6b7280;">Haz clic en "Generar QR" para cada campa√±a</p>
                </div>
                <div>
                    <h4 style="color: #4f46e5;">2. Descargar</h4>
                    <p style="color: #6b7280;">Descarga la imagen del c√≥digo QR generado</p>
                </div>
                <div>
                    <h4 style="color: #4f46e5;">3. Implementar</h4>
                    <p style="color: #6b7280;">Coloca el QR en tus materiales publicitarios</p>
                </div>
                <div>
                    <h4 style="color: #4f46e5;">4. Monitorear</h4>
                    <p style="color: #6b7280;">Revisa las estad√≠sticas en el dashboard</p>
                </div>
            </div>
        </div>

        <!-- Grid de campa√±as -->
        {% if campaigns %}
        <div class="campaigns-grid">
            {% for campaign in campaigns %}
            <div class="campaign-card">
                <div class="campaign-info">
                    <h3 style="color: #374151; margin-bottom: 10px;">{{ campaign.client }}</h3>
                    <p style="color: #6b7280; margin-bottom: 15px;">{{ campaign.description }}</p>
                    
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <strong style="color: #4f46e5;">Campa√±a:</strong>
                        <span style="color: #374151;">{{ campaign.campaign_code }}</span>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                        <strong style="color: #4f46e5;">Destino:</strong>
                        <a href="{{ campaign.destination }}" target="_blank" style="color: #4f46e5; text-decoration: none; font-size: 0.9em;">
                            Ver destino ‚Üó
                        </a>
                    </div>
                </div>

                <div class="campaign-url">
                    {{ request.host_url }}track?campaign={{ campaign.campaign_code }}
                </div>

                <div class="qr-container">
                    <div id="qr-{{ campaign.id }}" class="qr-code">
                        <p style="color: #6b7280;">Haz clic en "Generar QR" para crear el c√≥digo</p>
                    </div>
                </div>

                <div class="action-buttons">
                    <button onclick="generateQR('{{ campaign.campaign_code }}', {{ campaign.id }})" 
                            class="btn btn-primary btn-small">
                        üì± Generar QR
                    </button>
                    <button onclick="downloadQR({{ campaign.id }}, '{{ campaign.campaign_code }}')" 
                            class="btn btn-secondary btn-small" 
                            id="download-{{ campaign.id }}" 
                            style="display: none;">
                        üíæ Descargar
                    </button>
                    <button onclick="copyURL('{{ request.host_url }}track?campaign={{ campaign.campaign_code }}')" 
                            class="btn btn-outline btn-small">
                        üìã Copiar URL
                    </button>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div style="background: white; border-radius: 15px; padding: 40px; text-align: center; margin-top: 30px;">
            <h3 style="color: #6b7280;">No hay campa√±as configuradas</h3>
            <p style="color: #9ca3af; margin-bottom: 30px;">
                Contacta al administrador para configurar campa√±as
            </p>
            <a href="/dashboard" class="btn btn-primary">Ver Dashboard</a>
        </div>
        {% endif %}

        <!-- Botones de navegaci√≥n -->
        <div style="text-align: center; margin-top: 40px;">
            <a href="/dashboard" class="btn btn-secondary" style="margin-right: 15px;">
                üìä Ver Dashboard
            </a>
            <a href="/" class="btn btn-outline">
                üè† P√°gina Principal
            </a>
        </div>
    </div>

    <!-- Incluir librer√≠a QR -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    
    <script>
        // Generar c√≥digo QR
        async function generateQR(campaignCode, campaignId) {
            const qrContainer = document.getElementById(`qr-${campaignId}`);
            const downloadBtn = document.getElementById(`download-${campaignId}`);
            
            try {
                // Mostrar loading
                qrContainer.innerHTML = '<p style="color: #4f46e5;">Generando QR...</p>';
                
                const url = `{{ request.host_url }}track?campaign=${campaignCode}`;
                
                // Generar QR Code
                const qrCodeDataURL = await QRCode.toDataURL(url, {
                    width: 200,
                    height: 200,
                    color: {
                        dark: '#4f46e5',
                        light: '#ffffff'
                    },
                    errorCorrectionLevel: 'M',
                    margin: 2
                });
                
                // Mostrar QR
                qrContainer.innerHTML = `
                    <img src="${qrCodeDataURL}" alt="C√≥digo QR para ${campaignCode}" 
                         style="max-width: 100%; height: auto; border-radius: 8px;">
                `;
                
                // Mostrar bot√≥n de descarga
                downloadBtn.style.display = 'inline-block';
                downloadBtn.setAttribute('data-qr-url', qrCodeDataURL);
                
                console.log(`QR generado para campa√±a: ${campaignCode}`);
                
            } catch (error) {
                console.error('Error generando QR:', error);
                qrContainer.innerHTML = '<p style="color: #dc2626;">Error generando QR</p>';
            }
        }
        
        // Descargar QR
        function downloadQR(campaignId, campaignCode) {
            const downloadBtn = document.getElementById(`download-${campaignId}`);
            const qrDataURL = downloadBtn.getAttribute('data-qr-url');
            
            if (!qrDataURL) {
                alert('Primero genera el c√≥digo QR');
                return;
            }
            
            // Crear elemento de descarga
            const link = document.createElement('a');
            link.download = `QR_${campaignCode}_${new Date().toISOString().split('T')[0]}.png`;
            link.href = qrDataURL;
            
            // Simular clic para descargar
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log(`QR descargado: ${campaignCode}`);
        }
        
        // Copiar URL al portapapeles
        async function copyURL(url) {
            try {
                await navigator.clipboard.writeText(url);
                
                // Mostrar confirmaci√≥n temporal
                const originalText = event.target.textContent;
                event.target.textContent = '‚úÖ Copiado';
                event.target.style.background = '#10b981';
                
                setTimeout(() => {
                    event.target.textContent = originalText;
                    event.target.style.background = '';
                }, 2000);
                
                console.log('URL copiada:', url);
                
            } catch (error) {
                console.error('Error copiando URL:', error);
                
                // Fallback para navegadores que no soportan clipboard API
                const textArea = document.createElement('textarea');
                textArea.value = url;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                alert('URL copiada al portapapeles');
            }
        }
        
        // Generar todos los QRs autom√°ticamente (opcional)
        function generateAllQRs() {
            const campaigns = {{ campaigns | tojson }};
            campaigns.forEach((campaign, index) => {
                setTimeout(() => {
                    generateQR(campaign.campaign_code, campaign.id);
                }, index * 500); // Delay entre generaciones
            });
        }
        
        // Mostrar informaci√≥n adicional
        console.log('Generador de QR cargado');
        console.log('Host URL:', '{{ request.host_url }}');
        console.log('Campa√±as disponibles:', {{ campaigns | length }});
    </script>
</body>
</html>