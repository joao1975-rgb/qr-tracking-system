<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Redirigiendo...</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .tracking-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .tracking-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 60px 40px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            max-width: 500px;
            width: 90%;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #e5e7eb;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 30px;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            overflow: hidden;
            margin: 30px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4f46e5, #7c3aed);
            width: 0%;
            border-radius: 3px;
            transition: width 0.1s ease;
        }
        
        .client-info {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0e7ff 100%);
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .countdown {
            font-size: 2em;
            font-weight: bold;
            color: #4f46e5;
            margin: 20px 0;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="tracking-container">
        <div class="tracking-card">
            <div class="loading-spinner"></div>
            
            <h1 style="color: #374151; margin-bottom: 20px; font-size: 2em;">
                🚀 Cargando...
            </h1>
            
            <p style="color: #6b7280; font-size: 1.1em; margin-bottom: 30px;">
                Te estamos redirigiendo a tu destino
            </p>
            
            <div class="client-info">
                <h3 style="color: #4f46e5; margin-bottom: 10px;">{{ client }}</h3>
                <p style="color: #6b7280; font-size: 0.9em;">{{ campaign }}</p>
            </div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progress"></div>
            </div>
            
            <div class="countdown">
                <span id="countdown">3</span>
            </div>
            
            <p style="color: #9ca3af; font-size: 0.9em;">
                Serás redirigido automáticamente en <span id="countdown-text">3</span> segundos
            </p>
            
            <div style="margin-top: 30px;">
                <a href="{{ destination }}" id="manual-redirect" class="btn btn-primary" style="margin-right: 15px;">
                    Ir Ahora
                </a>
                <button onclick="history.back()" class="btn btn-secondary">
                    Volver
                </button>
            </div>
            
            <!-- Información del sistema (oculta) -->
            <div style="display: none;">
                <p>Session ID: {{ session_id }}</p>
                <p>Campaign: {{ campaign }}</p>
                <p>Client: {{ client }}</p>
                <p>Destination: {{ destination }}</p>
            </div>
        </div>
    </div>

    <script>
        // Datos de la sesión
        const sessionData = {
            session_id: '{{ session_id }}',
            destination: '{{ destination }}',
            client: '{{ client }}',
            campaign: '{{ campaign }}'
        };
        
        // Capturar datos adicionales del dispositivo
        function captureDeviceData() {
            const deviceData = {
                session_id: sessionData.session_id,
                screen_resolution: `${screen.width}x${screen.height}`,
                viewport_size: `${window.innerWidth}x${window.innerHeight}`,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                language: navigator.language,
                platform: navigator.platform,
                connection: navigator.connection ? navigator.connection.effectiveType : 'unknown'
            };
            
            // Enviar datos al servidor
            fetch('/collect-data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(deviceData)
            }).catch(err => console.log('Error enviando datos del dispositivo:', err));
        }
        
        // Marcar redirección como completada
        function markRedirectComplete() {
            fetch('/complete-redirect', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    session_id: sessionData.session_id
                })
            }).catch(err => console.log('Error marcando redirección:', err));
        }
        
        // Contador regresivo y progreso
        let timeLeft = 3;
        let progress = 0;
        const countdownElement = document.getElementById('countdown');
        const countdownTextElement = document.getElementById('countdown-text');
        const progressElement = document.getElementById('progress');
        
        // Capturar datos del dispositivo inmediatamente
        captureDeviceData();
        
        // Iniciar contador
        const timer = setInterval(function() {
            timeLeft--;
            progress += 33.33;
            
            countdownElement.textContent = timeLeft;
            countdownTextElement.textContent = timeLeft;
            progressElement.style.width = Math.min(progress, 100) + '%';
            
            if (timeLeft <= 0) {
                clearInterval(timer);
                countdownElement.textContent = "0";
                countdownTextElement.textContent = "0";
                progressElement.style.width = '100%';
                
                // Marcar como completado y redirigir
                markRedirectComplete();
                setTimeout(() => {
                    window.location.href = sessionData.destination;
                }, 500);
            }
        }, 1000);
        
        // Manejar redirección manual
        document.getElementById('manual-redirect').addEventListener('click', function(e) {
            e.preventDefault();
            clearInterval(timer);
            markRedirectComplete();
            window.location.href = sessionData.destination;
        });
        
        // Manejar visibilidad de la página (si el usuario cambia de pestaña)
        let startTime = Date.now();
        
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                console.log('Usuario cambió de pestaña');
            } else {
                console.log('Usuario regresó a la pestaña');
            }
        });
        
        // Registrar tiempo de permanencia antes de salir
        window.addEventListener('beforeunload', function() {
            const timeSpent = Math.round((Date.now() - startTime) / 1000);
            navigator.sendBeacon('/collect-data', JSON.stringify({
                session_id: sessionData.session_id,
                time_spent: timeSpent,
                exit_type: 'beforeunload'
            }));
        });
        
        // Analytics adicionales
        console.log('Tracking iniciado:', {
            session: sessionData.session_id,
            campaign: sessionData.campaign,
            client: sessionData.client,
            userAgent: navigator.userAgent,
            timestamp: new Date().toISOString()
        });
    </script>
</body>
</html>